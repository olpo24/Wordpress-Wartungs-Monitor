name: Build and Release Plugins

on:
  push:
    tags:
      - 'v*' # Wird ausgelÃ¶st, wenn du einen Tag pusht, der mit 'v' beginnt (z.B. v1.0.0)
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Extract Version from Tag
        id: get_version
        # Entfernt das 'v' vom Tag (aus v1.2.3 wird 1.2.3)
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Version in PHP files
        run: |
          # Ersetzt die Versionszeile in den Hauptdateien
          # Sucht nach 'Version: ...' und ersetzt es durch die aktuelle Tag-Version
          sed -i "s/Version: .*/Version: ${{ steps.get_version.outputs.VERSION }}/g" ./owwm/olpo-wordpress-wartungs-monitor.php
          sed -i "s/Version: .*/Version: ${{ steps.get_version.outputs.VERSION }}/g" ./owwm-child/owwm-connector.php
      - name: Create OWWM Plugin Zip
        run: |
          # Wir gehen davon aus, dass dein Dashboard-Plugin im Ordner 'dashboard' liegt
          zip -r owwm.zip ./owwm -x "*.git*" ".github*"

      - name: Create OWWM Child
        run: |
          # Wir gehen davon aus, dass dein Bridge-Plugin im Ordner 'bridge' liegt
          zip -r owwm-child.zip ./owwm-child -x "*.git*" ".github*"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            owwm.zip
            owwm-child.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
